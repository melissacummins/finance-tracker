<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            background: #5a6fd8;
        }

        .btn-secondary {
            background: #718096;
        }

        .btn-secondary:hover {
            background: #4a5568;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }

        .hidden {
            display: none !important;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .auth-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Loading Screen -->
        <div id="loadingScreen" style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 9999;
        ">
            <div style="text-align: center;">
                <h1 style="margin-bottom: 20px;">Financial Management System</h1>
                <div style="margin-bottom: 30px;">
                    <div class="loading-spinner"></div>
                </div>
                <p id="loadingMessage">Initializing application...</p>
            </div>
        </div>
        
        <!-- Main Application -->
        <div id="mainApp" style="display: none;">
            <div class="header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1>Financial Management System</h1>
                        <p>Import, categorize, and analyze your transactions with automated rules and projections</p>
                    </div>
                    <div id="authContainer">
                        <div id="signedOutContainer" style="display: none;">
                            <button class="btn" onclick="signInWithGoogle()" style="background: #4285f4;">
                                <span style="margin-right: 8px;">üîê</span>
                                Sign in with Google
                            </button>
                            <button class="btn btn-secondary" onclick="toggleDebug()" style="margin-left: 10px;">Debug</button>
                        </div>
                        <div id="signedInContainer" style="display: none;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="text-align: right;">
                                    <div id="userDisplayName" style="font-weight: bold;"></div>
                                    <div id="userEmail" style="font-size: 0.9em; opacity: 0.9;"></div>
                                </div>
                                <img id="userPhoto" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid white;">
                                <button class="btn btn-secondary" onclick="signOutUser()">Sign Out</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="syncStatus" style="margin-top: 10px; text-align: center; font-size: 0.9em; opacity: 0.9;">
                    <!-- Sync status will be shown here -->
                </div>
                
                <!-- Debug Panel -->
                <div id="debugPanel" style="display: none; margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.1); border-radius: 8px; font-family: monospace; font-size: 0.8em;">
                    <strong>Debug Information:</strong><br>
                    <div id="debugInfo">Loading debug info...</div>
                    <button class="btn btn-secondary" onclick="refreshDebugInfo()" style="margin-top: 10px;">Refresh</button>
                </div>
            </div>

            <div class="card">
                <h3>Dashboard</h3>
                <p>Application is working! You can now proceed with implementation.</p>
                <div id="statusMessage"></div>
            </div>
        </div>
    </div>

    <!-- Simplified Firebase Integration -->
    <script>
        console.log('Starting simplified initialization...');
        
        // Global variables
        let currentUser = null;
        let isFirebaseReady = false;
        let initializationStarted = false;

        // Try to load Firebase asynchronously
        function loadFirebase() {
            console.log('Attempting to load Firebase...');
            updateLoadingMessage('Connecting to Firebase...');
            
            // Use dynamic import to avoid syntax issues
            const script = document.createElement('script');
            script.type = 'module';
            script.textContent = `
                console.log('Firebase module script started');
                try {
                    const { initializeApp } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js');
                    const { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js');
                    const { getFirestore, doc, setDoc, getDoc } = await import('https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js');
                    
                    console.log('Firebase modules imported successfully');
                    
                    const firebaseConfig = {
                        apiKey: "AIzaSyCfcKmWAg7rnxVao5hNfgexb8FfPkwu2ww",
                        authDomain: "income-expenses-cash-flow.firebaseapp.com",
                        projectId: "income-expenses-cash-flow",
                        storageBucket: "income-expenses-cash-flow.firebasestorage.app",
                        messagingSenderId: "489754288851",
                        appId: "1:489754288851:web:a8151822e2066535746a26",
                        measurementId: "G-72Q1KQ4TFR"
                    };
                    
                    const app = initializeApp(firebaseConfig);
                    const auth = getAuth(app);
                    const db = getFirestore(app);
                    const provider = new GoogleAuthProvider();
                    
                    provider.addScope('email');
                    provider.addScope('profile');
                    
                    window.Firebase = {
                        app, auth, db, provider,
                        signInWithPopup, signOut, onAuthStateChanged,
                        doc, setDoc, getDoc,
                        initialized: true
                    };
                    
                    window.firebaseReady = true;
                    console.log('Firebase initialized successfully');
                    
                    // Initialize auth
                    initializeAuth();
                    
                } catch (error) {
                    console.error('Firebase loading failed:', error);
                    window.firebaseReady = false;
                    window.Firebase = { initialized: false, error: error.message };
                    initializeWithoutFirebase();
                }
            `;
            
            script.onerror = function(error) {
                console.error('Script loading error:', error);
                window.firebaseReady = false;
                initializeWithoutFirebase();
            };
            
            document.head.appendChild(script);
        }

        // Initialize with Firebase
        function initializeAuth() {
            if (!window.Firebase || !window.Firebase.initialized) {
                console.error('Firebase not available for auth');
                initializeWithoutFirebase();
                return;
            }

            updateLoadingMessage('Setting up authentication...');

            window.Firebase.onAuthStateChanged(window.Firebase.auth, (user) => {
                if (user) {
                    currentUser = user;
                    showSignedInState(user);
                    updateStatusMessage('Signed in successfully!');
                } else {
                    currentUser = null;
                    showSignedOutState();
                    updateStatusMessage('Ready to sign in');
                }
                hideLoadingScreen();
            });
        }

        // Initialize without Firebase
        function initializeWithoutFirebase() {
            if (initializationStarted) return;
            initializationStarted = true;
            
            console.log('Initializing without Firebase');
            updateLoadingMessage('Setting up local mode...');
            
            setTimeout(() => {
                showSignedOutState();
                updateStatusMessage('Running in local mode - Firebase unavailable');
                hideLoadingScreen();
            }, 1000);
        }

        // UI Functions
        function showSignedInState(user) {
            document.getElementById('signedOutContainer').style.display = 'none';
            document.getElementById('signedInContainer').style.display = 'block';
            document.getElementById('userDisplayName').textContent = user.displayName || 'User';
            document.getElementById('userEmail').textContent = user.email;
            document.getElementById('userPhoto').src = user.photoURL || '';
            updateSyncStatus('Connected to cloud storage');
        }

        function showSignedOutState() {
            document.getElementById('signedOutContainer').style.display = 'block';
            document.getElementById('signedInContainer').style.display = 'none';
            if (window.Firebase && window.Firebase.initialized) {
                updateSyncStatus('Sign in to sync data to the cloud');
            } else {
                updateSyncStatus('Using local storage only');
            }
        }

        function updateSyncStatus(message) {
            const statusElement = document.getElementById('syncStatus');
            if (statusElement) {
                statusElement.textContent = message;
            }
        }

        function updateStatusMessage(message) {
            const statusElement = document.getElementById('statusMessage');
            if (statusElement) {
                statusElement.innerHTML = '<strong>Status:</strong> ' + message;
            }
        }

        function hideLoadingScreen() {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
        }

        function updateLoadingMessage(message) {
            const loadingMessage = document.getElementById('loadingMessage');
            if (loadingMessage) {
                loadingMessage.textContent = message;
            }
        }

        // Auth Functions
        async function signInWithGoogle() {
            console.log('Sign in attempted');
            
            if (!window.Firebase || !window.Firebase.initialized) {
                alert('Firebase is not available. Please refresh the page and try again.');
                return;
            }

            try {
                updateSyncStatus('Signing in...');
                const result = await window.Firebase.signInWithPopup(window.Firebase.auth, window.Firebase.provider);
                console.log('Sign in successful:', result.user.email);
            } catch (error) {
                console.error('Sign in error:', error);
                updateSyncStatus('Sign in failed');
                
                if (error.code === 'auth/popup-blocked') {
                    alert('Popup was blocked. Please allow popups for this site and try again.');
                } else if (error.code === 'auth/popup-closed-by-user') {
                    alert('Sign in was cancelled.');
                } else {
                    alert('Failed to sign in: ' + error.message);
                }
            }
        }

        async function signOutUser() {
            if (!window.Firebase) {
                alert('Firebase is not available.');
                return;
            }

            try {
                await window.Firebase.signOut(window.Firebase.auth);
                console.log('User signed out');
            } catch (error) {
                console.error('Error signing out:', error);
                alert('Failed to sign out. Please try again.');
            }
        }

        // Debug Functions
        function toggleDebug() {
            const panel = document.getElementById('debugPanel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                refreshDebugInfo();
            } else {
                panel.style.display = 'none';
            }
        }

        function refreshDebugInfo() {
            const debugInfo = document.getElementById('debugInfo');
            const info = {
                'Firebase Ready': window.firebaseReady,
                'Firebase Object': !!window.Firebase,
                'Firebase Initialized': window.Firebase?.initialized,
                'Current User': !!currentUser,
                'Initialization Started': initializationStarted,
                'User Agent': navigator.userAgent.substring(0, 100) + '...'
            };

            let debugText = '';
            for (const [key, value] of Object.entries(info)) {
                debugText += key + ': ' + value + '<br>';
            }

            if (window.Firebase?.error) {
                debugText += '<br><strong>Firebase Error:</strong> ' + window.Firebase.error + '<br>';
            }

            debugInfo.innerHTML = debugText;
        }

        // Initialize on DOM load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, starting initialization...');
            updateLoadingMessage('Starting application...');
            
            // Give a moment for any issues to surface, then try Firebase
            setTimeout(() => {
                if (!initializationStarted) {
                    loadFirebase();
                    
                    // Fallback timer
                    setTimeout(() => {
                        if (!window.firebaseReady && !initializationStarted) {
                            console.warn('Firebase timeout, falling back to local mode');
                            initializeWithoutFirebase();
                        }
                    }, 5000);
                }
            }, 500);
        });

        console.log('Script loaded successfully');
    </script>
</body>
</html>
