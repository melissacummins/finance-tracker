<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 8px;
            padding: 5px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: #667eea;
            color: white;
        }

        .nav-tab:hover:not(.active) {
            background: #f0f2f5;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }

        .card h3 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.2em;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            background: #5a6fd8;
        }

        .btn-secondary {
            background: #718096;
        }

        .btn-secondary:hover {
            background: #4a5568;
        }

        .btn-danger {
            background: #e53e3e;
        }

        .btn-danger:hover {
            background: #c53030;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #4a5568;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        .grid {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .table th {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
        }

        .table tr:hover {
            background: #f7fafc;
        }

        .upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f7fafc;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            opacity: 0.9;
            font-size: 0.9em;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .header > div {
                flex-direction: column !important;
                text-align: center !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>Financial Management System</h1>
                    <p>Import, categorize, and analyze your transactions with automated rules and projections</p>
                </div>
                <div id="authContainer">
                    <div id="signedOutContainer">
                        <button class="btn" onclick="signInWithGoogle()" style="background: #4285f4;">
                            üîê Sign in with Google
                        </button>
                    </div>
                    <div id="signedInContainer" style="display: none;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="text-align: right;">
                                <div id="userDisplayName" style="font-weight: bold;"></div>
                                <div id="userEmail" style="font-size: 0.9em; opacity: 0.9;"></div>
                            </div>
                            <img id="userPhoto" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid white;">
                            <button class="btn btn-secondary" onclick="signOutUser()">Sign Out</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="syncStatus" style="margin-top: 10px; text-align: center; font-size: 0.9em; opacity: 0.9;">
                Sign in to sync data to the cloud
            </div>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">Dashboard</button>
            <button class="nav-tab" onclick="showTab('import')">Import Data</button>
            <button class="nav-tab" onclick="showTab('transactions')">Transactions</button>
            <button class="nav-tab" onclick="showTab('categories')">Categories</button>
            <button class="nav-tab" onclick="showTab('subscriptions')">Subscriptions</button>
            <button class="nav-tab" onclick="showTab('cashflow')">Cash Flow</button>
            <button class="nav-tab" onclick="showTab('rules')">Rules</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="dashboard-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalIncome">$0</div>
                    <div class="stat-label">Total Income</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalExpenses">$0</div>
                    <div class="stat-label">Total Expenses</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="netCashFlow">$0</div>
                    <div class="stat-label">Net Cash Flow</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="uncategorizedCount">0</div>
                    <div class="stat-label">Uncategorized Transactions</div>
                </div>
            </div>

            <div class="grid">
                <div class="card">
                    <h3>Recent Activity</h3>
                    <div id="recentTransactions">
                        <p>No transactions yet. Start by importing data or adding transactions manually.</p>
                    </div>
                </div>
                <div class="card">
                    <h3>Category Breakdown</h3>
                    <div id="categoryBreakdown">
                        <p>Categories will appear here once you add transactions.</p>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>Quick Actions</h3>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn" onclick="showTab('import')">Import Transactions</button>
                    <button class="btn btn-secondary" onclick="exportData()">Export Data</button>
                    <button class="btn btn-secondary" onclick="importData()">Import Data</button>
                </div>
            </div>
        </div>

        <!-- Import Data Tab -->
        <div id="import" class="tab-content">
            <div class="card">
                <h3>Import Transactions</h3>
                
                <div class="upload-area" id="uploadArea">
                    <p>Drag & drop your CSV/Excel file here or click to browse</p>
                    <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;">
                </div>

                <div id="mappingSection" class="hidden">
                    <h4>Column Mapping</h4>
                    <p>Map your file columns to the appropriate fields:</p>
                    
                    <div id="columnMapping" style="margin: 20px 0;"></div>

                    <div class="form-group">
                        <label>Account Type</label>
                        <select id="accountType" class="form-control">
                            <option value="checking">Checking Account</option>
                            <option value="credit">Credit Card</option>
                            <option value="savings">Savings Account</option>
                        </select>
                    </div>

                    <button class="btn" onclick="processImport()">Import Transactions</button>
                </div>
            </div>
        </div>

        <!-- Transactions Tab -->
        <div id="transactions" class="tab-content">
            <div class="card">
                <h3>All Transactions</h3>
                
                <div class="form-group">
                    <input type="text" id="transactionSearch" class="form-control" placeholder="Search transactions...">
                </div>

                <div class="form-group">
                    <select id="categoryFilter" class="form-control">
                        <option value="">All Categories</option>
                        <option value="uncategorized">Uncategorized Only</option>
                    </select>
                </div>

                <table class="table" id="transactionsTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Category</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Categories Tab -->
        <div id="categories" class="tab-content">
            <div class="grid">
                <div class="card">
                    <h3>Income Categories</h3>
                    <div id="incomeCategories"></div>
                    <button class="btn" onclick="addCategory('income')">Add Income Category</button>
                </div>
                <div class="card">
                    <h3>Expense Categories</h3>
                    <div id="expenseCategories"></div>
                    <button class="btn" onclick="addCategory('expense')">Add Expense Category</button>
                </div>
            </div>
        </div>

        <!-- Subscriptions Tab -->
        <div id="subscriptions" class="tab-content">
            <div class="card">
                <h3>Subscription Management</h3>
                <button class="btn" onclick="addSubscription()">Add Subscription</button>
                
                <div id="subscriptionsList"></div>
            </div>
        </div>

        <!-- Cash Flow Tab -->
        <div id="cashflow" class="tab-content">
            <div class="card">
                <h3>Cash Flow Analysis</h3>
                <p>Cash flow projections and analysis will be available here.</p>
            </div>
        </div>

        <!-- Rules Tab -->
        <div id="rules" class="tab-content">
            <div class="card">
                <h3>Categorization Rules</h3>
                <button class="btn" onclick="addRule()">Add New Rule</button>
                
                <div id="rulesList"></div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK v9 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, updateDoc, deleteDoc, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyCfcKmWAg7rnxVao5hNfgexb8FfPkwu2ww",
            authDomain: "income-expenses-cash-flow.firebaseapp.com",
            projectId: "income-expenses-cash-flow",
            storageBucket: "income-expenses-cash-flow.firebasestorage.app",
            messagingSenderId: "489754288851",
            appId: "1:489754288851:web:a8151822e2066535746a26",
            measurementId: "G-72Q1KQ4TFR"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        provider.addScope('email');
        provider.addScope('profile');
        
        window.firebaseServices = {
            auth, db, provider, signInWithPopup, signOut, onAuthStateChanged,
            doc, setDoc, getDoc, collection, addDoc, updateDoc, deleteDoc, 
            query, where, getDocs, orderBy
        };
        
        window.dispatchEvent(new Event('firebaseReady'));
    </script>

    <script>
        // Global data storage
        let transactions = [];
        let categories = {
            income: ['Direct Sales', 'Amazon', 'Kobo', 'Draft2Digital', 'Google Play', 'Patreon', 'Findaway', 'Kickstarter'],
            expense: ['Services', 'Shipping', 'Production', 'Marketing', 'Education', 'Business']
        };
        let rules = [];
        let subscriptions = [];
        let currentUser = null;
        let firebaseReady = false;

        // Wait for Firebase to be ready
        window.addEventListener('firebaseReady', function() {
            firebaseReady = true;
            initializeAuth();
        });

        // Authentication Functions
        function initializeAuth() {
            window.firebaseServices.onAuthStateChanged(window.firebaseServices.auth, (user) => {
                if (user) {
                    currentUser = user;
                    showSignedInState(user);
                    loadUserData();
                } else {
                    currentUser = null;
                    showSignedOutState();
                }
            });
        }

        function showSignedInState(user) {
            document.getElementById('signedOutContainer').style.display = 'none';
            document.getElementById('signedInContainer').style.display = 'block';
            document.getElementById('userDisplayName').textContent = user.displayName || 'User';
            document.getElementById('userEmail').textContent = user.email;
            document.getElementById('userPhoto').src = user.photoURL || '';
            document.getElementById('syncStatus').textContent = 'Connected - Data syncing to cloud';
        }

        function showSignedOutState() {
            document.getElementById('signedOutContainer').style.display = 'block';
            document.getElementById('signedInContainer').style.display = 'none';
            document.getElementById('syncStatus').textContent = 'Sign in to sync data to the cloud';
        }

        async function signInWithGoogle() {
            if (!firebaseReady) {
                alert('Firebase is not ready yet. Please wait a moment and try again.');
                return;
            }

            try {
                const result = await window.firebaseServices.signInWithPopup(window.firebaseServices.auth, window.firebaseServices.provider);
                console.log('Sign in successful:', result.user.email);
            } catch (error) {
                console.error('Sign in error:', error);
                if (error.code === 'auth/popup-blocked') {
                    alert('Popup was blocked. Please allow popups for this site and try again.');
                } else if (error.code === 'auth/popup-closed-by-user') {
                    alert('Sign in was cancelled.');
                } else {
                    alert('Failed to sign in: ' + error.message);
                }
            }
        }

        async function signOutUser() {
            try {
                await window.firebaseServices.signOut(window.firebaseServices.auth);
                console.log('User signed out');
            } catch (error) {
                console.error('Error signing out:', error);
            }
        }

        // Data Management
        async function loadUserData() {
            if (!currentUser || !firebaseReady) return;
            
            try {
                const userDocRef = window.firebaseServices.doc(window.firebaseServices.db, 'users', currentUser.uid);
                const userDoc = await window.firebaseServices.getDoc(userDocRef);
                
                if (userDoc.exists()) {
                    const data = userDoc.data();
                    transactions = data.transactions || [];
                    categories = data.categories || categories;
                    rules = data.rules || [];
                    subscriptions = data.subscriptions || [];
                } else {
                    await saveUserData();
                }
                
                updateDashboard();
                updateTransactionsTable();
                updateCategoriesView();
                
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        async function saveUserData() {
            if (!currentUser || !firebaseReady) return;
            
            try {
                const data = {
                    transactions,
                    categories,
                    rules,
                    subscriptions,
                    lastSaved: new Date().toISOString(),
                    userId: currentUser.uid
                };
                
                const userDocRef = window.firebaseServices.doc(window.firebaseServices.db, 'users', currentUser.uid);
                await window.firebaseServices.setDoc(userDocRef, data);
                
            } catch (error) {
                console.error('Error saving user data:', error);
            }
        }

        // UI Functions
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function updateDashboard() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            const monthlyTransactions = transactions.filter(t => {
                const date = new Date(t.date);
                return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            });

            const totalIncome = monthlyTransactions
                .filter(t => t.amount > 0)
                .reduce((sum, t) => sum + t.amount, 0);

            const totalExpenses = monthlyTransactions
                .filter(t => t.amount < 0)
                .reduce((sum, t) => sum + Math.abs(t.amount), 0);

            const uncategorizedCount = transactions.filter(t => 
                t.category === 'Uncategorized' || !t.category
            ).length;

            document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
            document.getElementById('totalExpenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('netCashFlow').textContent = formatCurrency(totalIncome - totalExpenses);
            document.getElementById('uncategorizedCount').textContent = uncategorizedCount;

            updateRecentTransactions();
        }

        function updateRecentTransactions() {
            const recent = transactions
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);

            const container = document.getElementById('recentTransactions');
            container.innerHTML = recent.length ? recent.map(t => `
                <div style="padding: 10px; border-bottom: 1px solid #e2e8f0;">
                    <strong>${t.description}</strong><br>
                    <small>${formatDate(t.date)} - ${t.category || 'Uncategorized'}</small>
                    <span style="float: right; color: ${t.amount > 0 ? 'green' : 'red'};">
                        ${formatCurrency(t.amount)}
                    </span>
                </div>
            `).join('') : '<p>No transactions yet. Start by importing data or adding transactions manually.</p>';
        }

        function updateTransactionsTable() {
            const tbody = document.querySelector('#transactionsTable tbody');
            tbody.innerHTML = transactions.map(t => `
                <tr>
                    <td>${formatDate(t.date)}</td>
                    <td>${t.description}</td>
                    <td style="color: ${t.amount > 0 ? 'green' : 'red'};">${formatCurrency(t.amount)}</td>
                    <td>${t.category || 'Uncategorized'}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="editTransaction('${t.id}')">Edit</button>
                        <button class="btn btn-danger" onclick="deleteTransaction('${t.id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateCategoriesView() {
            const incomeContainer = document.getElementById('incomeCategories');
            const expenseContainer = document.getElementById('expenseCategories');
            
            incomeContainer.innerHTML = categories.income.map(cat => `
                <div style="padding: 10px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                    <span>${cat}</span>
                    <button class="btn btn-danger" onclick="deleteCategory('income', '${cat}')">Delete</button>
                </div>
            `).join('');
            
            expenseContainer.innerHTML = categories.expense.map(cat => `
                <div style="padding: 10px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                    <span>${cat}</span>
                    <button class="btn btn-danger" onclick="deleteCategory('expense', '${cat}')">Delete</button>
                </div>
            `).join('');
        }

        // Utility Functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(amount);
        }

        function formatDate(date) {
            return new Date(date).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // Placeholder functions that will be implemented
        function addCategory(type) { 
            const name = prompt(`Enter ${type} category name:`);
            if (name && name.trim()) {
                categories[type].push(name.trim());
                updateCategoriesView();
                saveUserData();
            }
        }

        function deleteCategory(type, name) {
            if (confirm(`Delete ${name} category?`)) {
                categories[type] = categories[type].filter(cat => cat !== name);
                updateCategoriesView();
                saveUserData();
            }
        }

        function editTransaction(id) { 
            alert('Transaction editing coming soon'); 
        }

        function deleteTransaction(id) { 
            if (confirm('Delete this transaction?')) {
                transactions = transactions.filter(t => t.id !== id);
                updateDashboard();
                updateTransactionsTable();
                saveUserData();
            }
        }

        function addSubscription() { alert('Subscription management coming soon'); }
        function addRule() { alert('Rules management coming soon'); }
        function exportData() { alert('Export functionality coming soon'); }
        function importData() { alert('Import functionality coming soon'); }
        function processImport() { alert('Import processing coming soon'); }

        // Initialize the dashboard
        updateDashboard();
        updateCategoriesView();
    </script>
</body>
</html>
